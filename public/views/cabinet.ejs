<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Антибиотики</title>
	<link rel="stylesheet" type="text/css" href="../assets/stylesheets/cabinet_tch.css">
</head>
<body>
	<div class="form">
		<h1 class="title">
			Добро пожаловать
		</h1>

		<h1 class="title_username">
			<%= user.fio %>
		</h1>

		<a href="/logout" id="exit_link">Выйти из профиля</a>

		<div id="first_block">
			<h3 class="title_test">
				Группы:
			</h3>

			<div class="first_block_titles">
				<h4 class="first_inf_title">
					Наименование
				</h4>

				<h4 class="first_inf_title">
					Количество студентов
				</h4>

				<h4 class="first_inf_title">
					Средняя оценка группы
				</h4>

				<h4 class="first_inf_title">
					Подробнее
				</h4>
			</div>
			<div class="groups" id="groups">
				<div class="group_block">
					<h3>Создавть группу</h3>
					<input type="text" name="name" placeholder="Название" id="createGroupInp"><button id="createGroupBtn" type="button" name="button">Создать</button>

					<script type="text/javascript">
					document.getElementById('createGroupBtn').onclick = function() {
						let name = document.getElementById('createGroupInp').value;

						let xhr = new XMLHttpRequest();
						xhr.open('POST', '/createGroup', true);
						xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
						xhr.send(`name=${name}`);
						xhr.onload = function() {
							name = "";
							let div = document.createElement('div');
							div.className = 'group_block';
							resp = JSON.parse(xhr.responseText);
							div.innerHTML = `
							<h4 class="first_inf_title_1">${resp.name}<h4>
							<h4 class="first_inf_title_1">0</h4>
							<h4 style="padding-left: 18vh;" class="first_inf_title_1">0</h4>
							<a href="${resp._id}" class="first_inf_title_1">Просмотр</a>
							<button type="button" class="delayGroup" data-id="${resp._id}" name="button">Удалить</button>
							`;
							document.getElementById('groups').appendChild(div);
							document.querySelectorAll('.delayGroup')[document.querySelectorAll('.delayGroup').length - 1].onclick = removeGr;
						}
					}
					</script>
				</div>
				<% if (groups) {
					for (group of groups) { %>
						<div class="group_block">
							<h4 class="first_inf_title_1">
								<%= group.name %>
							</h4>

							<h4 class="first_inf_title_1">
								<% if (group.hasOwnProperty('students')){ %><%= group.students.length %> <%} else {%>0<%}%>
							</h4>

							<h4 style="padding-left: 18vh;" class="first_inf_title_1">
								<% if (group.hasOwnProperty('middleBall')){ %><%= group.middleBall %> <%} else {%>0<%}%>
							</h4>

							<a href="<%= group._id %>" class="first_inf_title_1">
								Просмотр
							</a>
							<button type="button" class="delayGroup" data-id="<%= group._id %>" name="button">Удалить</button>
						</div>
						<%	}
					} else {%><div class="group_block">Группы еще не созданые<%}%>

			</div>



			<img src="../assets/imgs/left.jpg" alt="" id="left_image">
			<img src="../assets/imgs/right.jpg" alt="" id="rignt_image">


			<p id="last_text">by Vylkov Dmitriy and Doctor Maxin</p>

		</div>
	</div>

	<script type="text/javascript">
		document.querySelectorAll('.delayGroup').forEach(el => {
			el.onclick = removeGr;
		})

		function removeGr(el) {
			if (!el.hasOwnProperty('dataset')) {
				el = el.target;
			}
			console.log(el);
			let xhr = new XMLHttpRequest();
			xhr.open('GET', `/delayGroup:${el.dataset.id}`, true);
			xhr.send();
			xhr.onload = function() {
				if (xhr.responseText == 'OK' ) {
					el.parentElement.remove();
				}
			}
		}
	</script>
</body>
</html>
